{
    "summary": "The code initializes server settings, handles errors, and provides functions for screenshots, UUID generation, keylogger extension. It manages HID events, sets event listeners for mouse movements, and sends events to the backend using POST requests.",
    "details": [
        {
            "comment": "This code initializes the server port, base URL, and backend URL for a keylogger browser extension. It also includes functions to get the current timestamp in Python style, take a screenshot of the viewport, convert it to a data URL, and submit the screenshot to a server.",
            "location": "\"/media/root/Toshiba XG3/works/cybergod_doc/src/the_frozen_forest_intro/keylogger_extension/virtual-keylogger/src/index.js\":0-28",
            "content": "console.log('Starting keylogger for browser');\nconst serverPort = 4471\nconst baseUrl = `http://localhost:${serverPort}`\nconst backendUrl = `${baseUrl}/browserInputEvent`;\nconst screenshotSubmitUrl = `${baseUrl}/submitScreenshot`;\n// const identifierUrl = `${baseUrl}/getIdentifier`;\nfunction getPythonStyleTimestamp() {\n  return new Date().getTime() / 1000\n}\nfunction getScreenshotDataUrl() {\n  const canvas = document.createElement('canvas');\n  canvas.width = window.innerWidth;\n  canvas.height = window.innerHeight;\n  const ctx = canvas.getContext('2d');\n  // Draw the screenshot of the viewport onto the canvas\n  ctx.drawImage(window, 0, 0, window.innerWidth, window.innerHeight);\n  // Convert the canvas content to a data URL representing the screenshot\n  const screenshotDataUrl = canvas.toDataURL('image/png');\n  // canvas.remove()\n  return screenshotDataUrl\n}\nfunction submitScreenshot(pageIdentifier) {\n  try {\n    let dataUrl = getScreenshotDataUrl()\n    fetch(screenshotSubmitUrl, { method: 'POST', data: JSON.stri"
        },
        {
            "comment": "This code is trying to post a screenshot and generate a unique identifier. If there's an error while posting the screenshot or generating the UUID, it logs the error message in the console. It checks if a high-precision timer is available before generating the UUID using either the random number generator from window.crypto or window.msCrypto (for Windows).",
            "location": "\"/media/root/Toshiba XG3/works/cybergod_doc/src/the_frozen_forest_intro/keylogger_extension/virtual-keylogger/src/index.js\":28-53",
            "content": "ngify({ client_id: pageIdentifier, timestamp: getPythonStyleTimestamp(), screenshot_data: dataUrl }) }).catch(e => {\n      console.log('error posting screenshot:', e.message);\n    })\n  } catch (e) {\n    console.log('error while submitting screenshot:', e.message)\n  }\n}\n// function generateUUIDFallback() {\n//   var d = new Date().getTime();\n//   if (window.performance && typeof window.performance.now === \"function\") {\n//     d += performance.now(); // use high-precision timer if available\n//   }\n//   var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n//     var r = (d + Math.random() * 16) % 16 | 0;\n//     d = Math.floor(d / 16);\n//     return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);\n//   });\n//   return uuid;\n// }\n// function generateUUID() {\n//   const crypto = window.crypto || window.msCrypto;\n//   if (crypto) {\n//     const array = new Uint32Array(4);\n//     crypto.getRandomValues(array);\n//     return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c)"
        },
        {
            "comment": "This code is initializing variables and defining the function `sendHIDEvent` which takes an event type and an event object as parameters. It extracts event data from the event object and may be used to handle keydown, keyup, mousedown, mouseup, and mousemove events. The `pageIdentifier` variable is assigned based on a generated UUID, and the `eventTypes` array can contain various event types to handle.",
            "location": "\"/media/root/Toshiba XG3/works/cybergod_doc/src/the_frozen_forest_intro/keylogger_extension/virtual-keylogger/src/index.js\":53-83",
            "content": " {\n//       const r = (array[0] & 0x0f) / 0x0f;\n//       const v = c === 'x' ? r : (r & 0x3 | 0x8);\n//       array = array.slice(1);\n//       return v.toString(16);\n//     });\n//   } else {\n//     console.error('crypto API not available');\n//     return generateUUIDFallback();\n//   }\n// }\n// const pageIdentifier = generateUUID();\n// fetch(identifierUrl, {\n//   method: \"GET\"\n// }).then(response => { const pageIdentifier = response.json()['client_id'] })\n// https://developer.mozilla.org/en-US/docs/Web/Events\n// noe we have click/dblclick, keypress events\n// how to handle them?\nconst eventTypes = ['keydown', 'keyup', 'mousedown', 'mouseup', 'mousemove'];\n// const eventTypes = ['keydown', 'keyup', 'mousedown', 'mouseup', 'mousemove', 'resize'];\nvar keylogger_timestamp_private = null; // you can check if this thing still works.\n// var pageIdentifier = null;\nfunction sendHIDEvent(event, e) {\n  let event_keys = Object.keys(e.__proto__);\n  let event_data = {}\n  for (let k of event_keys) {\n    event_data[k] = e[k];\n  }\n  "
        },
        {
            "comment": "Creating event object with timestamp and payload, then sending it to the backend using a POST request with JSON headers.",
            "location": "\"/media/root/Toshiba XG3/works/cybergod_doc/src/the_frozen_forest_intro/keylogger_extension/virtual-keylogger/src/index.js\":83-114",
            "content": "// debugger\n  keylogger_timestamp_private = getPythonStyleTimestamp();\n  const inputEvent = {\n    // eventType: event,\n    // timestamp: keylogger_timestamp_private,\n    // data: JSON.stringify(event_data),\n    // \"eventType\": event,\n    \"timestamp\": keylogger_timestamp_private,\n    \"client_id\": pageIdentifier,\n    \"payload\": { 'eventType': event, 'data': event_data },\n    // \"data\": JSON.stringify(event_data),\n    // data: JSON.stringify(e),\n    // data: e,\n  };\n  // console.log(inputEvent);\n  // debugger;\n  // console.log('payload:', JSON.stringify(inputEvent))\n  fetch(backendUrl, {\n    method: \"POST\",\n    // or you could remove the 'mode' parameter\n    mode: \"cors\", // you must use cors or the content will be unprocessable.\n    // mode: \"no-cors\",\n    headers: { \"Content-Type\": \"application/json\" },\n    // json: {browserEvent: inputEvent}\n    // body: inputEvent,\n    // body: \"hello world\",\n    // body: { body: JSON.stringify(inputEvent) },\n    body: JSON.stringify(inputEvent),\n  }).then((res) => {\n    // conso"
        },
        {
            "comment": "Sending event and handling errors\nExtracting page identifier from exposed function names\nSetting screenshot interval",
            "location": "\"/media/root/Toshiba XG3/works/cybergod_doc/src/the_frozen_forest_intro/keylogger_extension/virtual-keylogger/src/index.js\":114-143",
            "content": "le.log(`posted ${event} event`, res);\n    // console.log(`posted ${event} event`, res.json());\n  }).catch((err) => {\n    console.log(`error posting ${event} event`, err);\n  });\n}\nconst pageIdentifierPrefix = \"pageIdentifier_\";\nfunction getPageIdentifierFromExposedFunctionName() {\n  let wk = Object.keys(window)\n  let candidate_keys = [];\n  for (let k of wk) {\n    if (k.startsWith(pageIdentifierPrefix)) {\n      let myIdentifier = k.replace(pageIdentifierPrefix, \"\").replace(/\\_/g, \"-\");\n      candidate_keys.push(myIdentifier);\n    }\n  }\n  if (candidate_keys.length == 1) {\n    return candidate_keys[0];\n  } else {\n    console.error('Invalid page identifier candidates:', candidate_keys)\n  }\n  return 'unknown'\n}\nconst pageIdentifier = getPageIdentifierFromExposedFunctionName();\nconsole.log(`pageIdentifier: ${pageIdentifier}`)\nconst screenshotInterval = 2 * 1000;\n// usually we take screenshot on demand, not like this.\n// setInterval(() => submitScreenshot(pageIdentifier), screenshotInterval)\n// console.log(`taking screen"
        },
        {
            "comment": "Sets up event listeners for specified events to send HID (Hardware Input Device) events. The page identifier is retrieved based on the conditions specified in the function, and the listeners are added for each event type.",
            "location": "\"/media/root/Toshiba XG3/works/cybergod_doc/src/the_frozen_forest_intro/keylogger_extension/virtual-keylogger/src/index.js\":143-179",
            "content": "shot every ${screenshotInterval} ms`)\nfunction addSpecificEventListener(event) {\n  document.addEventListener(event, (e) => {\n    // console.log('event', event, e);\n    // debugger\n    // if (isVariableEmpty(pageIdentifier)) {\n    //   pageIdentifier = getPageIdentifierFromExposedFunctionName()\n    // not working for content script\n    // fetch(identifierUrl, {\n    //   method: \"GET\"\n    // }).then(response => {\n    //   pageIdentifier = response.json()['client_id'];\n    //   sendHIDEvent(event, e);\n    // })\n    // window.generateUUID(JSON.stringify({})).then(r => {\n    //   pageIdentifier = r;\n    //   sendHIDEvent(event, e);\n    // });\n    // } \n    // else {\n    sendHIDEvent(event, e);\n    // }\n  });\n}\n// window.generateUUID().then(pageIdentifier => {\nfor (const event of eventTypes) {\n  addSpecificEventListener(event, pageIdentifier);\n}\n// }); // this can be expected from playwright.\nfunction setElementAttributeAsCursorReady(element, elementId) {\n  element.style.position = \"absolute\";\n  element.style.pointerEvent"
        },
        {
            "comment": "Creates an omniscent pointer element with a red dot cursor and sets it as ready for the given element ID.",
            "location": "\"/media/root/Toshiba XG3/works/cybergod_doc/src/the_frozen_forest_intro/keylogger_extension/virtual-keylogger/src/index.js\":179-200",
            "content": "s = \"none\";\n  element.id = elementId;\n}\nfunction createOmniscentPointerElement(elementId) {\n  // var divElement = document.createElement(\"div\");\n  // divElement.style.width = \"10px\";\n  // divElement.style.height = \"10px\";\n  // divElement.style.backgroundColor = \"red\";\n  // divElement.style.borderRadius = \"50%\";\n  // setElementAttributeAsCursorReady(divElement, elementId)\n  // Create the img element\n  var imgElement = document.createElement(\"img\");\n  imgElement.src = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAUCAQAAAD8O3+kAAAA+ElEQVR4nHXOsSsEcBjG8S/nkOIGk+EyXHGuDIazyMRikbKgLC4ZZGAysPEnmC9lvOnKZjJcWQyUOqWQYpS7zrnjvpa7Y/jdO71Pn3qfFw7oOD/sd5C407IXpEmfnWmwE6CkNd9M/7AVoLL64lSdjSDpk5M11oOkD6aqrARJ7x2rsBwkvTNRZjFIeuPoBwtB0qLj78xBz19riSM+gSgjsWKetSZ9cck811ycUKALiABJKzbcdNiS53L27/mUVXclS/bUuskSiTZNuC05oqRnv/VYDtvULXkGgEi0cOurg4/EWpZjqLlllly1t0C8Rf3tAyNckaGvFX8Bxhaqb4UTp4MAAAAASUVORK5CYII=\";\n  setElementAttributeAsCursorReady(imgElement, elementId);\n  // Append the img element to the div element\n  //"
        },
        {
            "comment": "The code is responsible for managing the 'omniscent_pointer' element on the webpage. It checks if the pointer element is already present, creates it if not, and returns the pointer element. Additionally, an event listener is added to track mouse movements by capturing the clientX and clientY properties of the event object.",
            "location": "\"/media/root/Toshiba XG3/works/cybergod_doc/src/the_frozen_forest_intro/keylogger_extension/virtual-keylogger/src/index.js\":200-232",
            "content": " divElement.appendChild(imgElement);\n  // Insert the div element into the document body\n  document.body.appendChild(imgElement);\n  // document.body.appendChild(divElement);\n  return imgElement;\n  // return divElement;\n}\nconst pointerElementId = 'omniscent_pointer';\nfunction isVariableEmpty(v) {\n  return v === undefined | v == null\n}\nfunction getOmniscentPointer() {\n  // while (isVariableEmpty(vpointer)) {\n  var pointer = document.getElementById(pointerElementId);\n  if (isVariableEmpty(pointer)) {\n    console.log('pointer is undefined');\n    console.log('creating pointer element');\n    pointer = createOmniscentPointerElement(pointerElementId);\n    // pointer = createOmniscentPointerElement(pointerElementId);\n  }\n  // }\n  return pointer;\n}\n// sometimes this pointer is misaligned.\nfunction addMouseEventTracer(eventName) {\n  document.addEventListener(eventName, function (event) {\n    const x = event.clientX;\n    const y = event.clientY;\n    // const x = event.layerX;\n    // const y = event.layerY;\n    // const x = even"
        },
        {
            "comment": "This code is setting up event listeners for mouse events (mousedown, mouseup, and mousemove) to track the position of the cursor. It initially attempted to use a getOmniscentPointer function, but has been modified to set the position of the pointer element directly using CSS styles. The code will run after the DOM content is loaded, and it appears that there was some prior attempt to create a separate function for each event listener, which has now been simplified into a single loop over all events.",
            "location": "\"/media/root/Toshiba XG3/works/cybergod_doc/src/the_frozen_forest_intro/keylogger_extension/virtual-keylogger/src/index.js\":232-263",
            "content": "t.x;\n    // const y = event.y;\n    // var pointer = getOmniscentPointer();\n    const pointer = getOmniscentPointer();\n    // debugger;\n    // Set the position of the pointer element\n    pointer.style.left = x + 'px';\n    pointer.style.top = y + 'px';\n    // pointer.style.marginLeft = x + 'px';\n    // pointer.style.marginTop = y + 'px';\n  });\n}\n// it is this page creating havoc.\n// https://darkreader.org/help/zh-CN/\n// a little bit of fucked up.\n// let's not do this.\n// instead, render the mouse cursor later. could be more accurate and precise.\n// document.addEventListener('DOMContentLoaded', function () {\n// const mouseEvents = ['mousedown', 'mouseup', 'mousemove'];\n// for (let e of mouseEvents) {\n//   // Event listener for mouse movement\n//   addMouseEventTracer(e)\n// }\n// });"
        }
    ]
}